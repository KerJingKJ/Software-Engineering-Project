{% extends 'committee/base.html' %}
{% load static %}

{% block content %}
<div id="scholarship-form-container">
    <h2>{% if form.instance.pk %}Edit{% else %}Create{% endif %} Scholarship</h2>
    
    <div id="create-form">
        <form method="post">
            {% csrf_token %}

            {% for field in form %}
                <div class="form-group">
                    <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                    {{ field }}
                    {% if field.help_text %}
                        <small class="helptext">{{ field.help_text }}</small>
                    {% endif %}
                    {% if field.errors %}
                        <ul class="errorlist">
                        {% for error in field.errors %}<li>{{ error }}</li>{% endfor %}
                        </ul>
                    {% endif %}
                </div>
            {% endfor %}

            <hr style="margin: 30px 0;">

            <div class="criteria-section">
                <h3>Criteria & Entitlement</h3>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                    Add requirements like "SPM: 9As" or "Foundation: CGPA 3.5"
                </p>
                
                {{ formset.management_form }}

                <table id="criteria-table" style="width: 100%; text-align: left; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="width: 30%;">Qualification</th>
                            <th style="width: 30%;">Criteria Type </th>
                            <th style="width: 30%;">Minimum Requirement</th>
                            {% comment %} <th style="width: 30%;">Requirement</th> {% endcomment %}
                            <th style="width: 30%;">Entitlement</th>
                            <th style="width: 10%; padding-left: 5px; text-align: center;">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for form in formset %}
                            <tr class="criteria-row" {% if form.DELETE.value %}style="display:none"{% endif %}>
                                {% for hidden in form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                                
                                <td style="padding-right: 10px; padding-bottom: 10px;">{{ form.qualification }}</td>
                                <td style="padding-right: 10px; padding-bottom: 10px;">{{ form.criteria_type }}</td>
                                <td style="padding-right: 10px; padding-bottom: 10px; ">{{ form.min_value }}</td>
                                {% comment %} <td style="padding-right: 10px; padding-bottom: 10px;">{{ form.requirement }}</td> {% endcomment %}
                                <td style="padding-bottom: 10px;">{{ form.entitlement }}</td>
                                <td>
                                    {% if formset.can_delete %}
                                        <span style="display: none;">{{ form.DELETE }}</span>
                                        <button type="button" class="remove-row-btn">
                                            Remove
                                        </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% if form.errors %}
                            <tr>
                                <td colspan="4" style="color: red; padding-bottom: 10px;">
                                    {{ form.errors }}
                                </td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>

                <button type="button" id="add-criteria-btn" class="button" style="background-color: #034EA1; color: white; margin-top: 10px; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.7em;">
                    + Add Another Criteria
                </button>
            </div>

            <div style="margin-top: 40px;">
                <button type="submit" class="button">Save Scholarship</button>
            </div>
        </form>
    </div>
</div>

<script type="text/template" id="empty-form-template">
    <tr class="criteria-row">
        <td style="padding-right: 10px; padding-bottom: 10px;">{{ formset.empty_form.qualification }}</td>
        <td style="padding-right: 10px; padding-bottom: 10px;">{{ formset.empty_form.criteria_type }}</td>
        <td style="padding-right: 10px; padding-bottom: 10px; ">{{ formset.empty_form.min_value }}</td>
        {% comment %} <td style="padding-right: 10px; padding-bottom: 10px;">{{ formset.empty_form.requirement }}</td> {% endcomment %}
        <td style="padding-bottom: 10px;">{{ formset.empty_form.entitlement }}</td>
        <td>
            {% if formset.can_delete %}
                <span style="display: none;">{{ formset.empty_form.DELETE }}</span>
                <button type="button" class="remove-row-btn">
                    Remove
                </button>
            {% endif %}
        </td>
    </tr>
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addBtn = document.getElementById('add-criteria-btn');
        const tableBody = document.querySelector('#criteria-table tbody');
        const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]'); 
        // We get the content from the script tag now
        const emptyFormHtml = document.getElementById('empty-form-template').innerHTML;

        addBtn.addEventListener('click', function(e) {
            e.preventDefault();

            // 1. Get current form count
            let formIdx = parseInt(totalFormsInput.value);

            // 2. Replace __prefix__ with the new index
            let newRowHtml = emptyFormHtml.replace(/__prefix__/g, formIdx);

            // 3. Append the new row
            tableBody.insertAdjacentHTML('beforeend', newRowHtml);

            // 4. Update the management form count
            totalFormsInput.value = formIdx + 1;

        });
        tableBody.addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('remove-row-btn')) {
                    e.preventDefault();
                    const row = e.target.closest('tr');
                    
                    // Find the hidden delete checkbox in this row
                    const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
                    
                    if (deleteCheckbox) {
                        // If it's an existing row (or standard Django formset row), check the delete box and hide
                        deleteCheckbox.checked = true;
                        row.style.display = 'none';
                    } else {
                        // Fallback for safety: if no checkbox found (unlikely), just remove DOM
                        row.remove();
                    }
                }
        });
    });
</script>
{% endblock %}