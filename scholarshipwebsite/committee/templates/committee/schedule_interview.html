{% extends 'committee/base.html' %}

{% block content %}
{% load static %}
<link href="{% static 'committee/css/scheduleInterview.css' %}" type="text/css" rel="stylesheet" />
<div class="schedule-container">
    <h1 class="schedule-title">Schedule Interview</h1>

    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}"
            style="color: red; margin-bottom: 20px; font-weight: bold;">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <form method="post">
        {% csrf_token %}

        <div class="schedule-layout">
            <!-- Calendar Section -->
            <div class="calendar-section">
                <div class="calendar-wrapper">
                    <div class="calendar-header">
                        <button type="button" class="calendar-nav" id="prevMonth">&lt;</button>
                        <span class="calendar-month" id="monthYear">June 2025 ‚ñº</span>
                        <button type="button" class="calendar-nav" id="nextMonth">&gt;</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        <div class="calendar-day-header">SUN</div>
                        <div class="calendar-day-header">MON</div>
                        <div class="calendar-day-header">TUE</div>
                        <div class="calendar-day-header">WED</div>
                        <div class="calendar-day-header">THU</div>
                        <div class="calendar-day-header">FRI</div>
                        <div class="calendar-day-header">SAT</div>
                    </div>
                    <input type="hidden" id="date" name="date" required>
                </div>

                <div class="timezone-wrapper">
                    <span class="timezone-icon">üåê</span>
                    <span>Time Zone:</span>
                    <select name="timezone" class="timezone-select">
                        <option value="SST" selected>Singapore Standard Time (SST)</option>
                        <option value="GMT+8">GMT+8 (Malaysia)</option>
                        <option value="UTC">UTC</option>
                    </select>
                </div>
            </div>

            <!-- Time Slots Section -->
            <div class="time-section">
                <div class="time-slots">
                    <button type="button" class="time-btn" data-time="9:00 AM">9:00 AM</button>
                    <button type="button" class="time-btn" data-time="9:30 AM">9:30 AM</button>
                    <button type="button" class="time-btn" data-time="10:00 AM">10:00 AM</button>
                    <button type="button" class="time-btn" data-time="10:30 AM">10:30 AM</button>
                    <button type="button" class="time-btn" data-time="11:00 AM">11:00 AM</button>
                    <button type="button" class="time-btn" data-time="11:30 AM">11:30 AM</button>
                    <button type="button" class="time-btn" data-time="12:00 AM">12:00 AM</button>
                    <button type="button" class="time-btn" data-time="12:30 PM">12:30 PM</button>
                    <button type="button" class="time-btn" data-time="1:00 PM">1:00 PM</button>
                    <button type="button" class="time-btn" data-time="1:30 PM">1:30 PM</button>
                    <button type="button" class="time-btn" data-time="2:00 PM">2:00 PM</button>
                </div>
                <input type="hidden" id="interview_time" name="interview_time" required>
            </div>
        </div>

        <button type="submit" class="confirm-btn">Confirm</button>
    </form>
</div>

<script>
    // Calendar Logic
    let currentDate = new Date();
    let selectedDate = null;

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const monthYear = document.getElementById('monthYear');

        // Clear existing days (keep headers)
        const headers = grid.querySelectorAll('.calendar-day-header');
        grid.innerHTML = '';
        headers.forEach(h => grid.appendChild(h));

        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'];
        monthYear.textContent = monthNames[month] + ' ' + year + ' ‚ñº';

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();

        // Empty cells for days before first day
        for (let i = 0; i < firstDay; i++) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'calendar-day disabled';
            grid.appendChild(emptyDiv);
        }

        // Days of month
        for (let day = 1; day <= daysInMonth; day++) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            dayDiv.textContent = day;

            const thisDate = new Date(year, month, day);
            if (thisDate < today.setHours(0, 0, 0, 0)) {
                dayDiv.classList.add('disabled');
            } else {
                dayDiv.onclick = () => selectDate(year, month, day, dayDiv);
            }

            if (selectedDate && selectedDate.getFullYear() === year &&
                selectedDate.getMonth() === month && selectedDate.getDate() === day) {
                dayDiv.classList.add('selected');
            }

            grid.appendChild(dayDiv);
        }
    }

    function selectDate(year, month, day, element) {
        selectedDate = new Date(year, month, day);

        // Format for input: YYYY-MM-DD
        const formatted = year + '-' +
            String(month + 1).padStart(2, '0') + '-' +
            String(day).padStart(2, '0');
        document.getElementById('date').value = formatted;

        // Update UI
        document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
        element.classList.add('selected');
    }

    document.getElementById('prevMonth').onclick = () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    };

    document.getElementById('nextMonth').onclick = () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    };

    // Time selection
    document.querySelectorAll('.time-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            document.getElementById('interview_time').value = btn.dataset.time;
        };
    });

    // Initialize with existing data if available
    {% if existing_interview %}
    // Pre-select existing date
    const existingDateStr = "{{ existing_interview.date|date:'Y-n-j' }}";
    const dateParts = existingDateStr.split('-');
    if (dateParts.length === 3) {
        const year = parseInt(dateParts[0]);
        const month = parseInt(dateParts[1]) - 1; // JS months are 0-indexed
        const day = parseInt(dateParts[2]);
        selectedDate = new Date(year, month, day);
        currentDate = new Date(year, month, 1); // Navigate calendar to that month

        // Set hidden input value
        document.getElementById('date').value = "{{ existing_interview.date|date:'Y-m-d' }}";
    }

    // Pre-select existing time
    const existingTime = "{{ existing_interview.interview_time }}";
    document.querySelectorAll('.time-btn').forEach(btn => {
        if (btn.dataset.time === existingTime) {
            btn.classList.add('selected');
            document.getElementById('interview_time').value = existingTime;
        }
    });

    // Pre-select existing timezone
    const existingTimezone = "{{ existing_interview.timezone }}";
    const tzSelect = document.querySelector('.timezone-select');
    if (tzSelect) {
        for (let i = 0; i < tzSelect.options.length; i++) {
            if (tzSelect.options[i].value === existingTimezone) {
                tzSelect.selectedIndex = i;
                break;
            }
        }
    }
    {% endif %}

    // Initialize calendar
    renderCalendar();
</script>
{% endblock %}