{% extends 'student/base.html' %}
{% load static %}

{% block content %}
<div class="form-container">
    
    <h1 class="page-title" style="margin-left: 10px;">Scholarship Application Form</h1>
    
    <div class="tabs-wrapper">
        <a href="{% url 'edit_application_form' form.instance.pk 1 %}" class="tab">Part 1</a>
        <a href="{% url 'edit_application_form' form.instance.pk 2 %}" class="tab">Part 2</a>
        <a href="#" class="tab active">Part 3: Family Background</a>
        <a href="{% url 'edit_application_form' form.instance.pk 4 %}" class="tab">Part 4</a>
    </div>

    <div class="form-content">
  <form
    method="POST"
    enctype="multipart/form-data"
  >
            {% csrf_token %}
            
                    {% comment %} LOL. wacky workaround {% endcomment %}
        <div style="display:none;">
            {{ form.scholarship }}
            {{ form.name }}
            {{ form.home_address }}
            {{ form.correspondence_address }}
            {{ form.ic_no }}
            {{ form.age }}
            {{ form.date_of_birth }}
            {{ form.intake }}
            {{ form.programme }}
            {{ form.student_identification_number }}
            {{ form.nationality }}
            {{ form.race }}
            {{ form.gender }}
            {{ form.contact_number }}
            {{ form.monthly_income }}
            {{ form.email_address }}
            {{ form.passport_photo }}
            {{ form.highest_qualification }}
            {{ form.academic_result }}
            {{ form.personal_achievement }}
            {{ form.supporting_document }}
            {% comment %} {{ form.ea_form }} {% endcomment %}
            {% comment %} {{ form.payslip }} {% endcomment %}
            {{ form.reason_deserve }}
        </div>

            <div class="guardian-card">
                <h3 class="card-title"><u>Guardian 1:</u></h3>
                
                <div class="form-row">
                    <label>Relationship:</label>
                    {{ form1.relationship }}
                    {% comment %} <select class="form-input small-select">
                        <option></option>
                        <option>Father</option>
                        <option>Mother</option>
                        <option>Guardian</option>
                    </select> {% endcomment %}
                </div>

                <div class="form-row">
                    <label>Name:</label>
                    {{ form1.name }}
                    {% comment %} <input type="text" class="form-input" placeholder="Enter your name"> {% endcomment %}
                </div>

                <div class="form-row">
                    <label>Identification Card Number:</label>
                    {{ form1.ic_no }}
                    {% comment %} <input type="text" class="form-input" placeholder="Example: 001122143344"> {% endcomment %}
                </div>

                <div class="form-row">
                    <label>Date of Birth:</label>
                    {{ form1.date_of_birth }}
                    {% comment %} <div class="date-inputs">
                        <input type="text" placeholder="DD">
                        <input type="text" placeholder="MM">
                        <input type="text" placeholder="YYYY">
                    </div> {% endcomment %}
                </div>

                <div class="form-row">
                    <label>Age:</label>
                    {{ form1.age }}
                    {% comment %} <input type="number" class="form-input small-input"> {% endcomment %}
                </div>

                <div class="form-row">
                    <label>Nationality:</label>
                    {{ form1.nationality }}
                    {% comment %} <select class="form-input small-select"><option></option><option>Malaysian</option></select> {% endcomment %}
                </div>

                <div class="form-row">
                    <label>Gender:</label>
                    {{ form1.gender }}
                    {% comment %} <select class="form-input small-select"><option></option><option>Male</option><option>Female</option></select> {% endcomment %}
                </div>

                <div class="form-row">
                    <label>Address:</label>
                    {{ form1.address }}
                    {% comment %} <textarea class="form-input" rows="2"></textarea> {% endcomment %}
                </div>

                <div class="form-row">
                    <label>Contact number:</label>
                    {{ form1.contact_number }}
                    {% comment %} <input type="text" class="form-input" placeholder="Example: 60123456789"> {% endcomment %}
                </div>

                <div class="form-row">
                    <label>Email Address:</label>
                    {{ form1.email_address }}
                    {% comment %} <input type="email" class="form-input"> {% endcomment %}
                </div>
            </div>

            <div class="guardian-card">
                <h3 class="card-title"><u>Guardian 2:</u></h3>
                              <div class="form-row">
                    <label>Relationship:</label>
                    {{ form2.relationship }}
                    {% comment %} <select class="form-input small-select">
                        <option></option>
                        <option>Father</option>
                        <option>Mother</option>
                        <option>Guardian</option>
                    </select> {% endcomment %}
                </div>

                <div class="form-row">
                    <label>Name:</label>
                    {{ form2.name }}
                    {% comment %} <input type="text" class="form-input" placeholder="Enter your name"> {% endcomment %}
                </div>

                <div class="form-row">
                    <label>Identification Card Number:</label>
                    {{ form2.ic_no }}
                    {% comment %} <input type="text" class="form-input" placeholder="Example: 001122143344"> {% endcomment %}
                </div>

                <div class="form-row">
                    <label>Date of Birth:</label>
                    {{ form2.date_of_birth }}
                    {% comment %} <div class="date-inputs">
                        <input type="text" placeholder="DD">
                        <input type="text" placeholder="MM">
                        <input type="text" placeholder="YYYY">
                    </div> {% endcomment %}
                </div>

                <div class="form-row">
                    <label>Age:</label>
                    {{ form2.age }}
                    {% comment %} <input type="number" class="form-input small-input"> {% endcomment %}
                </div>

                <div class="form-row">
                    <label>Nationality:</label>
                    {{ form2.nationality }}
                    {% comment %} <select class="form-input small-select"><option></option><option>Malaysian</option></select> {% endcomment %}
                </div>

                <div class="form-row">
                    <label>Gender:</label>
                    {{ form2.gender }}
                    {% comment %} <select class="form-input small-select"><option></option><option>Male</option><option>Female</option></select> {% endcomment %}
                </div>

                <div class="form-row">
                    <label>Address:</label>
                    {{ form2.address }}
                    {% comment %} <textarea class="form-input" rows="2"></textarea> {% endcomment %}
                </div>

                <div class="form-row">
                    <label>Contact number:</label>
                    {{ form2.contact_number }}
                    {% comment %} <input type="text" class="form-input" placeholder="Example: 60123456789"> {% endcomment %}
                </div>

                <div class="form-row">
                    <label>Email Address:</label>
                    {{ form2.email_address }}
                    {% comment %} <input type="email" class="form-input"> {% endcomment %}
                </div>
            </div>

            <div class="docs-section" style="background-color: white; border: 2px solid #0056b3; padding: 25px; border-radius: 8px; margin: 30px 10px;">
                <h3 class="card-title" style="color: #0056b3; margin-bottom: 20px;"><u>Supporting Documents</u></h3>
                
                <div class="form-row align-top">
                    <label style="width: 30%; font-weight: 700;">EA Form:</label>
                    <div style="width: 70%;">
                        {% if form.instance.ea_form %}
                            <div id="display_ea_form" class="file-display-box" style="width: 350px;">
                                <div class="file-info">
                                    <i class="fas fa-file-invoice file-icon"></i>
                                    <a href="{{ form.instance.ea_form.url }}" target="_blank" class="file-link">
                                        {{ form.instance.ea_form.name|slice:"9:" }}
                                    </a>
                                </div>
                                <button type="button" class="btn-change" onclick="toggleFileField('ea_form')">Change</button>
                            </div>
                            <div id="input_ea_form" style="display: none;">
                                {{ form.ea_form }}
                                <small><a href="#" onclick="cancelFileChange('ea_form'); return false;" style="color: #666;">Cancel</a></small>
                            </div>
                        {% else %}
                            {{ form.ea_form }}
                        {% endif %}
                        <div class="sub-label">Upload the latest EA Form (PDF/Image)</div>
                    </div>
                </div>
                
                <div class="form-row align-top" style="margin-top: 20px;">
                    <label style="width: 30%; font-weight: 700;">Latest 3 months payslip:</label>
                    <div style="width: 70%;">
                        {% if form.instance.payslip %}
                            <div id="display_payslip" class="file-display-box" style="width: 350px;">
                                <div class="file-info">
                                    <i class="fas fa-file-invoice-dollar file-icon"></i>
                                    <a href="{{ form.instance.payslip.url }}" target="_blank" class="file-link">
                                        {{ form.instance.payslip.name|slice:"9:" }}
                                    </a>
                                </div>
                                <button type="button" class="btn-change" onclick="toggleFileField('payslip')">Change</button>
                            </div>
                            <div id="input_payslip" style="display: none;">
                                {{ form.payslip }}
                                <small><a href="#" onclick="cancelFileChange('payslip'); return false;" style="color: #666;">Cancel</a></small>
                            </div>
                        {% else %}
                            {{ form.payslip }}
                        {% endif %}
                        <div class="sub-label">Combined PDF preferred</div>
                    </div>
                </div>
            </div>

            <div class="button-group-center">
                <a href="{% url 'edit_application_form' form.instance.pk 2 %}" style="text-decoration: none;" class="btn-back">Back</a>
                {% comment %} <a href="{% url 'edit_application_form' form.instance.pk 4 %}" style="text-decoration: none;" class="btn-next">Next</a> {% endcomment %}
                <button type="submit" class="btn-next">Next</button>
            </div>

        </form>
    </div>
</div>

<script>
  // --- Existing File Toggle Functions (Keep these) ---
  function toggleFileField(fieldName) {
    document.getElementById('display_' + fieldName).style.display = 'none';
    document.getElementById('input_' + fieldName).style.display = 'block';
  }

  function cancelFileChange(fieldName) {
    document.getElementById('display_' + fieldName).style.display = 'flex';
    document.getElementById('input_' + fieldName).style.display = 'none';
    const input = document.querySelector('#input_' + fieldName + ' input[type="file"]');
    if (input) input.value = ''; 
  }

  // --- NEW: Guardian Age Auto-Calculation ---
  document.addEventListener('DOMContentLoaded', function () {

    // Helper function to setup auto-calc for a specific guardian
    // We pass the IDs of the Date input and Age input
    function setupGuardianAutoAge(dobId, ageId) {
        const dobInput = document.getElementById(dobId);
        const ageInput = document.getElementById(ageId);

        if (!dobInput || !ageInput) return; // Safety check

        function calculate() {
            const dobValue = dobInput.value;
            if (dobValue) {
                // Parse Date (Local Time) to avoid timezone bugs
                const parts = dobValue.split('-');
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; 
                const day = parseInt(parts[2]);
                
                const dob = new Date(year, month, day);
                const today = new Date();

                let calculatedAge = today.getFullYear() - dob.getFullYear();
                const m = today.getMonth() - dob.getMonth();
                
                // Adjust if birthday hasn't happened yet this year
                if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
                    calculatedAge--;
                }

                // Set the value
                ageInput.value = calculatedAge;
            }
        }

        // Listen for changes
        dobInput.addEventListener('change', calculate);
        dobInput.addEventListener('input', calculate);
        
        // Run immediately (in case data is already loaded)
        calculate();
    }

    // --- Apply to Guardian 1 ---
    // Django automatically creates IDs like 'id_prefix-fieldname'
    setupGuardianAutoAge('id_guardian1-date_of_birth', 'id_guardian1-age');

    // --- Apply to Guardian 2 ---
    setupGuardianAutoAge('id_guardian2-date_of_birth', 'id_guardian2-age');

  });
</script>
{% endblock %}