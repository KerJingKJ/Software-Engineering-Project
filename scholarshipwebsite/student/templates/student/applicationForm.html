{% extends 'student/base.html' %} {% load static %} {% block content %}
<div class="form-container">
  <h1 class="page-title" style="margin-left: 10px">
    Scholarship Application Form
  </h1>
  <hr class="divider" />
  <form method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    <div style="display:none;">
      {{ form.personal_achievement }}
      {{ form.supporting_document }}
      {{ form.ea_form }}
      {{ form.payslip }}
      {{ form.reason_deserve }}
    </div>
    <div class="form-row" style="margin-bottom: 30px">
      <label class="form-label">Scholarship Type:</label>
      {{ form.scholarship }}
    </div>

    <div class="tabs-wrapper">
      <a href="#" class="tab active">Part 1: Personal Information</a>
      {% if form.instance.pk %}
      <a href="{% url 'edit_application_form' form.instance.pk 2 %}" class="tab">Part 2</a>
      <a href="{% url 'edit_application_form' form.instance.pk 3 %}" class="tab">Part 3</a>
      <a href="{% url 'edit_application_form' form.instance.pk 4 %}" class="tab">Part 4</a>
      {% else %}
      <a href="#" class="tab">Part 2</a>
      <a href="#" class="tab">Part 3</a>
      <a href="#" class="tab">Part 4</a>
      {% endif %}
    </div>

    <div class="form-content">
      <div class="form-row">
        <label>Name:</label>
        {{ form.name }}
      </div>

      <div class="form-row">
        <label>Home Address:</label>
        {{ form.home_address }}
      </div>

      <div class="form-row">
        <label>Correspondence Address:</label>
        {{ form.correspondence_address }}
      </div>

      <div class="form-row">
        <label>IC No.:</label>
        {{ form.ic_no }}
      </div>

      <div class="form-row">
        <label>Age:</label>
        {{ form.age }}
        
      </div>

      
      <div class="form-row">
        <label>Date of Birth:</label>
        <div class="stacked-inputs">
          {{ form.date_of_birth }}

        </div>
      </div>

      <div class="form-row">
        <label>Intake:</label>
        <div class="stacked-inputs">
            {{ form.intake }}
            
            <div id="js-intake-error"
                style="color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 5px 10px; border-radius: 4px; font-size: 0.9em; display: none;">
                <i class="fas fa-exclamation-circle"></i> Intake date cannot be in the future.
            </div>
        </div>
      </div>
      
      <div class="form-row">
        <label>Programme:</label>
        {{ form.programme }}
      </div>

      <div class="form-row">
        <label>Student ID:</label>
        {{ form.student_identification_number }}
      </div>

      <div class="form-row">
        <label>Nationality:</label>
        {{ form.nationality }}
      </div>

      <div class="form-row">
        <label>Race:</label>
        {{ form.race }}
      </div>

      <div class="form-row">
        <label>Gender:</label>
        {{ form.gender }}
      </div>

      <div class="form-row">
        <label>Contact number(Mobile):</label>
        {{ form.contact_number }}
      </div>

      <div class="form-row">
        <label>Household (Monthly Income): RM</label>
        {{ form.monthly_income }}
      </div>

      <div class="form-row">
        <label>Email Address:</label>
        {{ form.email_address }}
      </div>

      <div class="form-row align-top">
        <label>Upload your Passport Photo:</label>
        
        <div class="stacked-inputs">
            {% if form.instance.passport_photo %}
                
                <div id="display_passport_photo" class="file-display-box">
                    <div class="file-info">
                        <i class="fas fa-file-image file-icon"></i>
                        <a href="{{ form.instance.passport_photo.url }}" target="_blank" class="file-link">
                            {{ form.instance.passport_photo.name|slice:"16:" }}
                        </a>
                    </div>
                    <button type="button" class="btn-change" onclick="toggleFileField('passport_photo')">
                        Change
                    </button>
                </div>

                <div id="input_passport_photo" style="display: none;">
                    {{ form.passport_photo }}
                    <div class="sub-label">Supported formats: JPG, PNG, PDF</div>
                    <div style="margin-top:5px;">
                        <small><a href="#" onclick="cancelFileChange('passport_photo'); return false;" style="color: #666;">Cancel change</a></small>
                    </div>
                </div>

            {% else %}
                <div style="width: 250px;">{{ form.passport_photo }}</div>
                <div class="sub-label" >Supported formats: JPG, PNG, PDF</div>
            {% endif %}
        </div>
      </div>

      <div class="form-row">
        <label>Highest Qualification:</label>
        <div class="stacked-inputs">
          {{ form.highest_qualification }}
        </div>
      </div>

      <div class="form-row align-top">
        <label>Academic Result:</label>
        <div class="stacked-inputs">
            {% if form.instance.academic_result %}
                
                <div id="display_academic_result" class="file-display-box">
                    <div class="file-info">
                        <i class="fas fa-file-image file-icon"></i>
                        <a href="{{ form.instance.academic_result.url }}" target="_blank" class="file-link">
                            {{ form.instance.academic_result.name|slice:"16:" }}
                        </a>
                    </div>
                    <button type="button" class="btn-change" onclick="toggleFileField('academic_result')">
                        Change
                    </button>
                </div>

                <div id="input_academic_result" style="display: none;">
                    {{ form.academic_result }}
                    <div class="sub-label">Supported formats: JPG, PNG, PDF</div>
                    <div style="margin-top:5px;">
                        <small><a href="#" onclick="cancelFileChange('academic_result'); return false;" style="color: #666;">Cancel change</a></small>
                    </div>
                </div>

            {% else %}
                <div style="width: 250px;">{{ form.academic_result }}</div>
                <div class="sub-label" >Supported formats: JPG, PNG, PDF</div>
            {% endif %}
        </div>
      </div>

      <div class="button-container">
        <button type="submit" class="btn-next">Next</button>
      </div>
    </div>
  </form>
</div>

<script>
  // --- Helper Functions for File Inputs ---
  function toggleFileField(fieldName) {
    document.getElementById('display_' + fieldName).style.display = 'none';
    document.getElementById('input_' + fieldName).style.display = 'block';
  }

  function cancelFileChange(fieldName) {
    document.getElementById('display_' + fieldName).style.display = 'flex';
    document.getElementById('input_' + fieldName).style.display = 'none';
    const input = document.querySelector('#input_' + fieldName + ' input[type="file"]');
    if (input) input.value = ''; 
  }

  document.addEventListener('DOMContentLoaded', function () {
    // --- Elements ---
    const ageInput = document.getElementById('id_age');
    const dobInput = document.getElementById('id_date_of_birth');
    const ageErrorDiv = document.getElementById('js-age-dob-error');
    
    const intakeInput = document.getElementById('id_intake');
    const intakeErrorDiv = document.getElementById('js-intake-error');
    
    const form = document.querySelector('form');

    // --- 1. Auto-Calculate Age Logic ---
    function autoCalculateAge() {
      const dobValue = dobInput.value;

      // Only run if a Date is selected
      if (dobValue) {
        // Parse Date (Local Time)
        const parts = dobValue.split('-');
        const year = parseInt(parts[0]);
        const month = parseInt(parts[1]) - 1; 
        const day = parseInt(parts[2]);
        
        const dob = new Date(year, month, day);
        const today = new Date();

        let calculatedAge = today.getFullYear() - dob.getFullYear();
        const m = today.getMonth() - dob.getMonth();
        
        // Adjust if birthday hasn't happened yet this year
        if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
          calculatedAge--;
        }

        // AUTO-FILL THE AGE INPUT
        ageInput.value = calculatedAge;
        
        // Hide error message since it's now mathematically correct
        if (ageErrorDiv) ageErrorDiv.style.display = 'none';
      }
    }

    // --- 2. Intake Validation Logic ---
    function validateIntake() {
        const intakeValue = intakeInput.value;
        if (intakeValue) {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayString = `${year}-${month}-${day}`;

            if (intakeValue > todayString) {
                if (intakeErrorDiv) intakeErrorDiv.style.display = 'block';
                return false;
            }
        }
        if (intakeErrorDiv) intakeErrorDiv.style.display = 'none';
        return true;
    }

    // --- Event Listeners ---
    if (dobInput) {
        // Calculate immediately when date changes
        dobInput.addEventListener('change', autoCalculateAge);
        dobInput.addEventListener('input', autoCalculateAge);
        // Run once on load to set initial Age if DOB exists
        autoCalculateAge();
    }

    if (intakeInput) {
        intakeInput.addEventListener('change', validateIntake);
        intakeInput.addEventListener('input', validateIntake);
        // Run once on load to show existing errors if any
        validateIntake();
    }

    // --- Form Submit Handler ---
    if (form) {
        form.addEventListener('submit', function (e) {
          // We only need to validate Intake. Age is now auto-calculated and safe.
          const isIntakeValid = validateIntake();

          if (!isIntakeValid) {
            e.preventDefault(); 
            if (intakeErrorDiv) {
                 intakeErrorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }
        });
    }
  });
</script>

<style>
    #id_intake {
        width: fit-content !important;
    }
    #id_date_of_birth {
        width: fit-content !important;
    }
</style>
{% endblock %}