{% extends 'student/base.html' %} {% load static %} {% block content %}
<div class="form-container">
  <h1 class="page-title" style="margin-left: 10px">
    Scholarship Application Form
  </h1>
  <hr class="divider" />
  <form method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    <div style="display:none;">
      {% comment %} {{ form.scholarship }} {% endcomment %}
      {% comment %} {{ form.name }} {% endcomment %}
      {% comment %} {{ form.home_address }} {% endcomment %}
      {% comment %} {{ form.correspondence_address }} {% endcomment %}
      {% comment %} {{ form.ic_no }} {% endcomment %}
      {% comment %} {{ form.age }} {% endcomment %}
      {% comment %} {{ form.date_of_birth }} {% endcomment %}
      {% comment %} {{ form.intake }} {% endcomment %}
      {% comment %} {{ form.programme }} {% endcomment %}
      {% comment %} {{ form.student_identification_number }} {% endcomment %}
      {% comment %} {{ form.nationality }} {% endcomment %}
      {% comment %} {{ form.race }} {% endcomment %}
      {% comment %} {{ form.gender }} {% endcomment %}
      {% comment %} {{ form.contact_number }} {% endcomment %}
      {% comment %} {{ form.monthly_income }} {% endcomment %}
      {% comment %} {{ form.email_address }} {% endcomment %}
      {% comment %} {{ form.passport_photo }} {% endcomment %}
      {% comment %} {{ form.education_level }} {% endcomment %}
      {% comment %} {{ form.academic_result }} {% endcomment %}
      {{ form.personal_achievement }}
      {{ form.supporting_document }}
      {{ form.ea_form }}
      {{ form.payslip }}
      {{ form.reason_deserve }}
    </div>
    <div class="form-row" style="margin-bottom: 30px">
      <label class="form-label">Scholarship Type:</label>
      {{ form.scholarship }}
    </div>

    <div class="tabs-wrapper">
      <a href="#" class="tab active">Part 1: Personal Information</a>
      {% if form.instance.pk %}
      <a href="{% url 'edit_application_form' form.instance.pk 2 %}" class="tab">Part 2</a>
      <a href="{% url 'edit_application_form' form.instance.pk 3 %}" class="tab">Part 3</a>
      <a href="{% url 'edit_application_form' form.instance.pk 4 %}" class="tab">Part 4</a>
      {% else %}
      <a href="#" class="tab">Part 2</a>
      <a href="#" class="tab">Part 3</a>
      <a href="#" class="tab">Part 4</a>
      {% endif %}
    </div>

    <div class="form-content">
      <div class="form-row">
        <label>Name:</label>
        {{ form.name }}
      </div>

      <div class="form-row">
        <label>Home Address:</label>
        {{ form.home_address }}
      </div>

      <div class="form-row">
        <label>Correspondence Address:</label>
        {{ form.correspondence_address }}
      </div>

      <div class="form-row">
        <label>IC No.:</label>
        {{ form.ic_no }}
      </div>


      <div class="form-row">
        <label>Age:</label>
        {{ form.age }}
        <div style="color: red; font-size: 0.9em;">
          {{ form.age.errors }}
        </div>
      </div>

      {% if form.non_field_errors %}
      <div class="alert alert-danger"
        style="color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; padding: 15px; margin-bottom: 20px; border: 1px solid transparent; border-radius: 4px;">
        {% for error in form.non_field_errors %}
        <p style="margin: 0; padding: 0;">
          <i class="fas fa-exclamation-circle"></i> {{ error }}
        </p>
        {% endfor %}
      </div>
      {% endif %}
      <div class="form-row">
        <label>Date of Birth:</label>
        <div class="stacked-inputs">
          {{ form.date_of_birth }}

          <div id="js-age-dob-error"
            style="color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 5px 10px; border-radius: 4px; font-size: 0.9em; margin-top: 5px;">
            <i class="fas fa-exclamation-circle"></i> Age doesn't match the date of birth provided.
          </div>
        </div>
      </div>

      <div class="form-row">
        <label>Intake:</label>
        <div class="stacked-inputs">
            {{ form.intake }}
            
            <div id="js-intake-error"
                style="color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 5px 10px; border-radius: 4px; font-size: 0.9em; display: none;">
                <i class="fas fa-exclamation-circle"></i> Intake date cannot be in the future.
            </div>
        </div>
      </div>
      
      <div class="form-row">
        <label>Programme:</label>
        {{ form.programme }}
      </div>

      <div class="form-row">
        <label>Student ID:</label>
        {{ form.student_identification_number }}
      </div>

      <div class="form-row">
        <label>Nationality:</label>
        {{ form.nationality }}
      </div>

      <div class="form-row">
        <label>Race:</label>
        {{ form.race }}
      </div>

      <div class="form-row">
        <label>Gender:</label>
        {{ form.gender }}
      </div>

      <div class="form-row">
        <label>Contact number(Mobile):</label>
        {{ form.contact_number }}
      </div>

      <div class="form-row">
        <label>Household (Monthly Income): RM</label>
        {{ form.monthly_income }}
      </div>

      <div class="form-row">
        <label>Email Address:</label>
        {{ form.email_address }}
      </div>

      <div class="form-row">
        <label>Upload your Passport Photo:</label>
        {{ form.passport_photo }}
      </div>

      <div class="form-row align-top">
        <label>Highest Qualification:</label>
        <div class="stacked-inputs">
          {{ form.highest_qualification }}
        </div>
      </div>

      <div class="form-row">
        <label>Academic Result:</label>
        {{ form.academic_result }}
      </div>

      <div class="button-container">
        <button type="submit" class="btn-next">Next</button>
      </div>
    </div>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const ageInput = document.getElementById('id_age');
    const dobInput = document.getElementById('id_date_of_birth');
    const errorDiv = document.getElementById('js-age-dob-error');

    const intakeInput = document.getElementById('id_intake');
    const intakeErrorDiv = document.getElementById('js-intake-error');

    const form = document.querySelector('form');

    function validateAgeVsDob() {
      const age = parseInt(ageInput.value);
      const dobValue = dobInput.value;

      if (!isNaN(age) && dobValue) {
        const dob = new Date(dobValue);
        const today = new Date();

        // Calculate age
        let calculatedAge = today.getFullYear() - dob.getFullYear();
        const m = today.getMonth() - dob.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
          calculatedAge--;
        }

        // Match backend logic: abs(calculated_age - age) > 1 is an error
        if (Math.abs(calculatedAge - age) > 1) {
          errorDiv.style.display = 'block';
          return false;
        } else {
          errorDiv.style.display = 'none';
          return true;
        }
      }
      errorDiv.style.display = 'none';
      return true;
    }
    function validateIntake() {
        const intakeValue = intakeInput.value;
        if (intakeValue) {
            // Get today's date in YYYY-MM-DD string format
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayString = `${year}-${month}-${day}`;

            // Compare strings (ISO format YYYY-MM-DD allows direct comparison)
            if (intakeValue > todayString) {
                intakeErrorDiv.style.display = 'block'; // Show error in the next line
                return false;
            }
        }
        intakeErrorDiv.style.display = 'none';
        return true;
    }

    if (ageInput && dobInput) {
        ageInput.addEventListener('input', validateAgeVsDob);
        dobInput.addEventListener('change', validateAgeVsDob);
    }

    if (intakeInput) {
        // Trigger validation immediately when the date changes
        intakeInput.addEventListener('change', validateIntake);
        // Also trigger on input if users can type manually
        intakeInput.addEventListener('input', validateIntake);
    }

    form.addEventListener('submit', function (e) {
      const isAgeValid = validateAgeVsDob();
      const isIntakeValid = validateIntake();

      if (!isAgeValid || !isIntakeValid) {
        e.preventDefault();
        
        // Scroll to the specific error
        if (!isIntakeValid) {
             intakeErrorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else if (!isAgeValid) {
             ageErrorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    });
  });
</script>

<style>
    #id_intake {
        width: 98% !important;
    }
    #id_date_of_birth {
        width: 98% !important;
    }
</style>
{% endblock %}