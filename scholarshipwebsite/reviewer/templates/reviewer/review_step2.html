{% extends 'reviewer/base.html' %}
{% block content %}
<style>
    .review-container {
        display: flex;
        flex-direction: row;
        gap: 20px;
        padding: 20px;
        height: calc(100vh - 80px);
        overflow: hidden;
    }

    .column {
        flex: 1;
        display: flex;
        flex-direction: column;
        border: 2px solid #ccc;
        border-radius: 8px;
        background-color: white;
        overflow: hidden;
    }

    .column-header {
        text-align: center;
        padding: 15px;
        font-size: 1.5rem;
        font-weight: bold;
        border-bottom: 2px solid #ccc;
        background-color: white;
        z-index: 10;
    }

    .scrollable-content {
        padding: 20px;
        overflow-y: auto;
        flex: 1;
    }

    .guardian-card {
        background-color: #7da5d8;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        color: black;
        border: 1px solid #5b8abf;
    }

    .guardian-card h3 {
        margin-top: 0;
        margin-bottom: 15px;
        font-weight: bold;
        text-decoration: underline;
        font-size: 1.1rem;
    }

    .info-row {
        display: flex;
        margin-bottom: 8px;
        align-items: center;
    }

    .info-label {
        font-weight: bold;
        width: 140px;
        flex-shrink: 0;
    }

    .info-value {
        background-color: white;
        padding: 4px 10px;
        border-radius: 15px;
        flex: 1;
        min-height: 28px;
        display: flex;
        align-items: center;
        border: 1px solid #ccc;
    }

    .docs-section {
        border: 2px solid #5b8abf;
        border-radius: 15px;
        padding: 15px;
        margin-top: 20px;
        background-color: white;
    }

    .docs-header {
        font-weight: bold;
        text-decoration: underline;
        margin-bottom: 10px;
        display: block;
    }


    .rubric-section {
        border: 1px solid #7da5d8;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .rubric-title {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .rubric-box {
        border: 1px solid #aaa;
        padding: 15px;
        border-radius: 5px;
        background-color: #fcfcfc;
    }

    .rubric-box h4 {
        margin-top: 0;
        font-size: 1rem;
        font-weight: bold;
    }

    .formula-box {
        border: 1px solid #ccc;
        padding: 10px;
        margin: 10px 0;
        text-align: center;
        background-color: #f0f0f0;
        font-family: monospace;
    }

    .pci-options {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 10px;
    }

    .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .checkbox-item {
        display: flex;
        align-items: flex-start;
        gap: 10px;
    }

    .checkbox-item input[type="checkbox"] {
        margin-top: 5px;
    }

    .nav-buttons {
        display: flex;
        justify-content: center;
        gap: 50px;
        padding: 20px 0;
    }

    .btn-nav {
        padding: 10px 30px;
        border: none;
        border-radius: 5px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        width: 100px;
        text-align: center;
        text-decoration: none;
    }

    .btn-prev {
        background-color: #2b5797;
    }

    .btn-next {
        background-color: #2b5797;
    }

    .btn-nav:hover {
        opacity: 0.9;
    }
</style>

<div class="container-fluid">
    <h1>Scholarship Review - Step 2</h1>

    <div class="review-container">

        <div class="column">
            <div class="column-header">Applicant Form</div>
            <div class="scrollable-content">
                <p style="font-style: italic; color: #666; margin-bottom: 10px;">Family Background</p>

                {% for guardian in guardians %}
                <div class="guardian-card">
                    <h3>Guardian {{ forloop.counter }}:</h3>

                    <div class="info-row">
                        <span class="info-label">Relationship:</span>
                        <div class="info-value">
                            {{ guardian.relationship }}
                        </div>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Name:</span>
                        <div class="info-value">
                            {{ guardian.name }}
                        </div>
                    </div>
                    <div class="info-row">
                        <span class="info-label">IC Number:</span>
                        <div class="info-value">
                            {{ guardian.ic_no }}
                        </div>
                    </div>
                    <div class="info-row">
                        <span class="info-label" style="width: auto; min-width: 100px;">Date of Birth:</span>
                        <div class="info-value" style="width: 130px; flex: none; margin-right: 15px;">
                            {{ guardian.date_of_birth }}
                        </div>
                        <span class="info-label" style="width: auto; min-width: 40px; margin-right: 10px;">Age:</span>
                        <div class="info-value" style="width: 60px; flex: none;">
                            {{ guardian.age }}
                        </div>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Nationality:</span>
                        <div class="info-value">
                            {{ guardian.nationality }}
                        </div>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Gender:</span>
                        <div class="info-value">
                            {{ guardian.gender }}
                        </div>
                    </div>
                    <div class="info-row" style="align-items: flex-start;">
                        <span class="info-label" style="margin-top: 5px;">Address:</span>
                        <div class="info-value" style="height: auto; min-height: 60px;">
                            {{ guardian.address }}
                        </div>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Contact number:</span>
                        <div class="info-value">
                            {{ guardian.contact_number }}
                        </div>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Email Address:</span>
                        <div class="info-value">
                            {{ guardian.email_address }}
                        </div>
                    </div>
                </div>
                {% empty %}
                <p>No Guardian Information Available.</p>
                {% endfor %}


                <div class="guardian-card" style="background-color: white; border: 2px solid #2b5797; padding: 15px;">
                    <span class="docs-header">Supporting Documents:</span>

                    <div style="margin-top: 5px;">
                        <strong>EA Form:</strong>
                        {% if app.ea_form and app.ea_form.name %}<a href="{{ app.ea_form.url }}"
                            target="_blank">ea.pdf</a>{% else %}N/A{% endif %}
                    </div>
                    <div style="margin-top: 5px;">
                        <strong>Latest 3 months payslip:</strong>
                        {% if app.payslip and app.payslip.name %}<a href="{{ app.payslip.url }}"
                            target="_blank">payslip.pdf</a>{% else %}N/A{% endif %}
                    </div>
                </div>

            </div>
        </div>


        <div class="column">
            <div class="column-header">Criteria Rubrics</div>
            <div class="scrollable-content">
                <form method="post">
                    {% csrf_token %}


                    <div class="rubric-section" style="border: 2px solid #2b5797;">
                        <div class="rubric-title">1. Data Integrity Check</div>
                        <div class="rubric-box"
                            style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <div style="font-weight: bold; margin-bottom: 5px;">Income Proof Match:</div>
                                <div style="font-size: 0.9rem; color: #444;">Uploaded "EA Form" and "Payslip" match the
                                    declared figures.</div>
                            </div>
                            <input {{ integrity_attr }} type="checkbox" name="integrity_income_check"
                                style="width: 20px; height: 20px;">
                        </div>
                    </div>


                    <div class="rubric-section" style="border: 2px solid #2b5797;">
                        <div class="rubric-title">2. Financial Priority Scoring</div>
                        <div class="rubric-box">
                            <div style="font-weight: bold; margin-bottom: 15px;">
                                <div style="margin-bottom: 10px;">Calculate using PCI, Formula:</div>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div
                                        style="display: flex; flex-direction: column; align-items: center; min-width: 200px;">
                                        <div
                                            style="border-bottom: 2px solid black; padding: 0 10px; width: 100%; text-align: center;">
                                            RM {{ total_income_str }} (Total Income)
                                        </div>
                                        <div style="padding: 2px 10px 0 10px; font-size: 0.85rem;">
                                            {{ family_count }} (Family Members)
                                        </div>
                                    </div>
                                    <div style="color: #2b5797; font-size: 1.2rem;">
                                        <strong>= RM {{ pci_str }}</strong>
                                    </div>
                                </div>
                            </div>

                            <div style="font-size: 0.9rem; margin-bottom: 15px; line-height: 1.4;">
                                (1) Low Need (T20): PCI > <b>RM 5,000</b><br>
                                (2) Moderate Need (M40): PCI <b>RM 2,501 - RM 5,000</b><br>
                                (3) High Need (B40): PCI <b>RM 1,201 - RM 2,500</b><br>
                                (4) Critical Need (B40): PCI < <b>RM 1,200</b>
                            </div>

                            <div class="pci-options">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="radio" name="financial_priority" value="1" {{ fp_1_attr }}>
                                    (1) Low Need (T20)
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="radio" name="financial_priority" value="2" {{ fp_2_attr }}>
                                    (2) Moderate Need (M40)
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="radio" name="financial_priority" value="3" {{ fp_3_attr }}>
                                    (3) High Need (B40)
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="radio" name="financial_priority" value="4" {{ fp_4_attr }}>
                                    (4) Critical Need (B40)
                                </label>
                            </div>
                        </div>
                    </div>


                    <div class="rubric-section" style="border: 2px solid #2b5797;">
                        <div class="rubric-title">3. Hardship & Burden Indicators</div>
                        <div class="rubric-box">
                            <div class="checkbox-group">
                                <label class="checkbox-item" style="cursor: pointer;">
                                    <input type="radio" name="hardship" value="single_income" {{ hs_attr }}>
                                    <div>
                                        <div style="font-weight: bold;">Single Income/Single Parent</div>
                                        <div style="font-size: 0.85rem; color: #555;">Only one breadwinner listed</div>
                                    </div>
                                </label>
                                <label class="checkbox-item" style="cursor: pointer;">
                                    <input type="radio" name="hardship" value="large_family" {{ hl_attr }}>
                                    <div>
                                        <div style="font-weight: bold;">Large Family</div>
                                        <div style="font-size: 0.85rem; color: #555;">5+ dependents (siblings) listed in
                                            the full form</div>
                                    </div>
                                </label>
                                <label class="checkbox-item" style="cursor: pointer;">
                                    <input type="radio" name="hardship" value="retiree" {{ hr_attr }}>
                                    <div>
                                        <div style="font-weight: bold;">Retiree/Pensioner</div>
                                        <div style="font-size: 0.85rem; color: #555;">Guardian age is >60 or listed as
                                            "Pensioner"</div>
                                    </div>
                                </label>
                                <label class="checkbox-item" style="cursor: pointer;">
                                    <input type="radio" name="hardship" value="medical" {{ hm_attr }}>
                                    <div>
                                        <div style="font-weight: bold;">Medical Burden</div>
                                        <div style="font-size: 0.85rem; color: #555;">Evidence of chronic illness in the
                                            family</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="rubric-section" style="border: 2px solid #2b5797;">
                        <div class="rubric-title">C. Personal Statement / Essay Quality</div>
                        <div class="rubric-box">
                            <div class="checkbox-group">
                                <label class="checkbox-item" style="cursor: pointer;">
                                    <input type="radio" name="essay" value="compelling" {{ ec_attr }}>
                                    <div>
                                        <div style="font-weight: bold;">Compelling</div>
                                        <div style="font-size: 0.85rem; color: #555;">Unique story, clear goals,
                                            specific alignment with MMU/Scholarship values.</div>
                                    </div>
                                </label>
                                <label class="checkbox-item" style="cursor: pointer;">
                                    <input type="radio" name="essay" value="generic" {{ eg_attr }}>
                                    <div>
                                        <div style="font-weight: bold;">Generic</div>
                                        <div style="font-size: 0.85rem; color: #555;">Standard answers, lacks specific
                                            examples.</div>
                                    </div>
                                </label>
                                <label class="checkbox-item" style="cursor: pointer;">
                                    <input type="radio" name="essay" value="poor" {{ ep_attr }}>
                                    <div>
                                        <div style="font-weight: bold;">Poor</div>
                                        <div style="font-size: 0.85rem; color: #555;">Grammatical errors, off-topic, or
                                            too short.</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="nav-buttons">
                        <button type="submit" name="previous" class="btn-nav btn-prev">Previous</button>
                        <button type="submit" name="next" class="btn-nav btn-next"
                            onclick="return validateForm()">Next</button>
                    </div>

                    <script>
                        function validateForm() {
                            let errors = [];

                            // 1. Data Integrity Check - must be checked
                            const integrity = document.querySelector('input[name="integrity_income_check"]');
                            if (!integrity || !integrity.checked) {
                                errors.push("Data Integrity Check must be selected");
                            }

                            // 2. Financial Priority - must select one
                            const fp = document.querySelector('input[name="financial_priority"]:checked');
                            if (!fp) {
                                errors.push("Financial Priority Scoring must have one option selected");
                            }

                            // 3. Hardship - must select one
                            const hardship = document.querySelector('input[name="hardship"]:checked');
                            if (!hardship) {
                                errors.push("Hardship & Burden Indicators must have one option selected");
                            }

                            // 4. Essay Quality - must select one
                            const essay = document.querySelector('input[name="essay"]:checked');
                            if (!essay) {
                                errors.push("Personal Statement / Essay Quality must have one option selected");
                            }

                            if (errors.length > 0) {
                                alert("Please complete the following requirements:\n\n- " + errors.join("\n- "));
                                return false;
                            }
                            return true;
                        }
                    </script>

                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}